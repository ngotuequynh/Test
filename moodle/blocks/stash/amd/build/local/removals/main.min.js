define("block_stash/local/removals/main",["exports","core/modal_factory","core/modal_events","core/templates","block_stash/local/trade_adder/main","core/ajax","block_stash/local/datasources/items-getter","core/str","core/toast"],(function(_exports,_modal_factory,_modal_events,_templates,tradeAdder,_ajax,getItems,_str,Toast){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),tradeAdder=_interopRequireWildcard(tradeAdder),_ajax=_interopRequireDefault(_ajax),getItems=_interopRequireWildcard(getItems),Toast=_interopRequireWildcard(Toast);const showModal=async function(courseid){let editdetails=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const modal=await buildModal(courseid,editdetails);displayModal(modal,courseid)},buildModal=async(courseid,editdetails)=>{let quizzes=await fetchQuizData(courseid);quizzes.activities.forEach((quiz=>{quiz.selected=!1,0!==editdetails.length&&quiz.id==editdetails.quizid&&(quiz.selected=!0)}));let context={courseid:courseid,quizzes:quizzes.activities};if(0!==editdetails.length){let allitems=await getItems.getIndexedItems(courseid),additemsdata=[];editdetails.items.forEach((item=>{additemsdata.push({itemid:item.itemid,name:allitems[item.itemid].name,quantity:item.quantity,imageurl:allitems[item.itemid].imageurl})})),context.additems=additemsdata,context.removalid=editdetails.removalid}return window.console.log(context),_modal_factory.default.create({title:(0,_str.get_string)("configureremoval","block_stash"),body:_templates.default.render("block_stash/local/removal/removal_form",context),type:_modal_factory.default.types.SAVE_CANCEL})},displayModal=async(modal,courseid)=>{modal.getRoot().on(_modal_events.default.bodyRendered,(()=>{tradeAdder.init(),tradeAdder.registerActions()})),modal.getRoot().on(_modal_events.default.save,(()=>{saveData(courseid)})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show()},saveData=async courseid=>{let itemsinfo=document.querySelectorAll(".block-stash-quantity"),items=[],returnitemdata=[];itemsinfo.forEach((item=>{let itemid=item.closest(".block-stash-trade-item").getAttribute("data-id"),basedata={itemid:parseInt(itemid),quantity:parseInt(item.value)},fulldata={itemid:parseInt(itemid),quantity:parseInt(item.value),name:item.closest(".block-stash-trade-item").children[0].innerText.trim()};items.push(basedata),returnitemdata.push(fulldata)}));let quizselect=document.querySelector(".block-stash-quiz-select"),cmid=quizselect.value;if("0"===cmid)return await Toast.addToastRegion(document.querySelector(".modal-body")),Toast.add((0,_str.get_string)("selectquizcheck","block_stash"),{type:"danger",autohide:!0,closeButton:!0}),!1;let removalid=0,removalelement=document.getElementById("block_stash_removal_id");removalid=removalelement?updateRemovalEntry(courseid,parseInt(cmid),items,removalelement.dataset.id).then((()=>{Toast.add((0,_str.get_string)("configupdated","block_stash"),{type:"info",autohide:!0,closeButton:!0})})):await saveRemovalEntry(courseid,parseInt(cmid),items);let context={cmid:cmid,cmname:quizselect.item(quizselect.selectedIndex).text,courseid:courseid,removalid:removalid,items:returnitemdata,editinfo:JSON.stringify(items)};_templates.default.render("block_stash/local/removal/table_row",context).then(((html,js)=>{if(removalelement){let tmpe=document.querySelector('.block-stash-removal-edit[data-id="'+removalid+'"').closest("tr"),things=_templates.default.replaceNode(tmpe,html,js);registerDeleteEvent(courseid,things[0].querySelector(".block-stash-removal-icon")),registerEditEvent(courseid,things[0].querySelector(".block-stash-removal-edit"))}else{let tableobject=document.querySelector(".block-stash-removal-body"),things=_templates.default.appendNodeContents(tableobject,html,js);registerDeleteEvent(courseid,things[0].querySelector(".block-stash-removal-icon")),registerEditEvent(courseid,things[0].querySelector(".block-stash-removal-edit"))}}))},registerDeleteEvent=(courseid,deleteobject)=>{deleteobject.addEventListener("click",(e=>{e.preventDefault();let deletionelement=e.currentTarget,removalid=deletionelement.dataset.id;deleteRemovalEntry(courseid,parseInt(removalid)).then((()=>{deletionelement.closest("tr").remove(),Toast.add((0,_str.get_string)("configdeleted","block_stash"),{type:"info",autohide:!0,closeButton:!0})}))}))},registerEditEvent=(courseid,editobject)=>{editobject.addEventListener("click",(e=>{e.preventDefault();let jsondata=JSON.parse(editobject.dataset.json),details={removalid:editobject.dataset.id,quizid:editobject.dataset.quiz,items:jsondata};showModal(courseid,details)}))};_exports.init=courseid=>{document.querySelector(".block-config-removal").addEventListener("click",(e=>{e.preventDefault(),showModal(courseid)})),document.querySelectorAll(".block-stash-removal-icon").forEach((deleteobject=>{registerDeleteEvent(courseid,deleteobject)})),document.querySelectorAll(".block-stash-removal-edit").forEach((editobject=>{registerEditEvent(courseid,editobject)}))};const fetchQuizData=courseid=>_ajax.default.call([{methodname:"block_stash_get_removal_activities",args:{courseid:courseid}}])[0],saveRemovalEntry=(courseid,cmid,items)=>_ajax.default.call([{methodname:"block_stash_save_removal",args:{courseid:courseid,cmid:cmid,items:items}}])[0],updateRemovalEntry=(courseid,cmid,items,removalid)=>_ajax.default.call([{methodname:"block_stash_save_removal",args:{courseid:courseid,cmid:cmid,items:items,removalid:removalid}}])[0],deleteRemovalEntry=(courseid,removalid)=>_ajax.default.call([{methodname:"block_stash_delete_removal",args:{courseid:courseid,removalid:removalid}}])[0]}));

//# sourceMappingURL=main.min.js.map