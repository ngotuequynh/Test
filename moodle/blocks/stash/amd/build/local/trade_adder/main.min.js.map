{"version":3,"file":"main.min.js","sources":["../../../src/local/trade_adder/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Code to make the item selector work.\n *\n * @copyright  2024 Adrian Greeve\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport * as getItems from 'block_stash/local/datasources/items-getter';\n\nexport const init = async () => {\n    // Fetch items to populate the select box.\n    let maindiv = document.querySelector('.block-stash-item-adder');\n    let courseid = maindiv.dataset.courseId;\n    let itemdata = await getItems.getItems(courseid);\n\n    // populate the list\n    let listelements = document.querySelectorAll('.dropdown-list');\n    listelements.forEach((listelement) => {\n        let listnode = listelement.querySelector('ul');\n        for (let item of itemdata.items) {\n\n            let type = listelement.closest('.block_stash_item_box').dataset.type;\n\n            let listitem = document.createElement('li');\n            listitem.innerHTML = item.name;\n            listitem.classList.add('dropdown-item');\n            listitem.setAttribute('tabindex', '0');\n            listitem.dataset.itemid = item.id;\n            listitem.dataset.imgurl = item.imageurl;\n            listitem.addEventListener('click', (e) => addItemToTable(e, type));\n            listitem.addEventListener('keyup', (e) => {\n                if (e.keyCode === 13) {\n                    addItemToTable(e, type);\n                }\n            });\n            listnode.appendChild(listitem);\n        }\n    });\n\n    /**\n     * @param {Event} e\n     */\n    function toggleMenu(e) {\n        let currentbutton = e.currentTarget;\n        let dropdownlist = currentbutton.parentNode.querySelector('.dropdown-list');\n        dropdownlist.style.display = (dropdownlist.style.display == 'none') ? 'block' : 'none';\n    }\n\n    let selectors = document.querySelectorAll('.item-adder-add');\n    selectors.forEach((selector) => {\n        selector.addEventListener('click', toggleMenu);\n        selector.addEventListener('keyup', (e) => {\n            if (e.keyCode === 13 || e.keyCode === 32) {\n                toggleMenu(e);\n            }\n        });\n    });\n\n    let searchboxes = document.querySelectorAll('.dropdown-search');\n    searchboxes.forEach((searchbox) => {\n        searchbox.addEventListener('keyup', (e) => {\n            let currentelement = e.currentTarget;\n            let dropdowncontainer = currentelement.closest('.dropdown-container');\n            let dropdownlist = dropdowncontainer.querySelector('.dropdown-list');\n            let searchterm = currentelement.value.toLowerCase();\n            let listitems = dropdownlist.querySelectorAll('.dropdown-item');\n            for (let item of listitems) {\n                let itemtext = item.innerText.toLowerCase();\n                if (itemtext.indexOf(searchterm) === -1) {\n                    item.style.display = 'none';\n                } else {\n                    item.style.display = 'block';\n                }\n            }\n        });\n    });\n\n    document.addEventListener('mouseup', (e) => {\n        let searchboxes = document.querySelectorAll('.dropdown-search');\n        searchboxes.forEach((searchbox) => {\n            searchbox.value = '';\n        });\n        let dropdowncontainers = document.querySelectorAll('.dropdown-container');\n        let currentelement = e.target;\n        dropdowncontainers.forEach((dropdowncontainer) => {\n            let dropdownlist = dropdowncontainer.querySelector('.dropdown-list');\n            if (!dropdowncontainer.contains(currentelement)) {\n                dropdownlist.style.display = 'none';\n                let listitems = dropdownlist.querySelectorAll('.dropdown-item');\n                for (let item of listitems) {\n                    item.style.display = 'block';\n                }\n            }\n        });\n    });\n};\n\nconst addItemToTable = (e, typeinfo) => {\n    let itemnode = e.currentTarget;\n    let data = {\n        itemid: itemnode.dataset.itemid,\n        imageurl: itemnode.dataset.imgurl,\n        name: itemnode.innerText,\n        quantity: 1\n    };\n\n    let type = typeinfo;\n\n    let templatename = (type === 'gain') ? 'block_stash/trade_add_item_detail' : 'block_stash/trade_loss_item_detail';\n    Templates.render(templatename, data).done((html, js) => {\n        let itemsbox = document.querySelector('.block_stash_item_box[data-type=\"' + type + '\"]');\n        Templates.appendNodeContents(itemsbox, html, js);\n        registerActions();\n    });\n};\n\nexport const registerActions = () => {\n    let deleteelements = document.getElementsByClassName('block-stash-delete-item');\n    for (let delement of deleteelements) {\n        delement.addEventListener('click', deleteItem);\n    }\n};\n\nconst deleteItem = (element) => {\n    let child = element.currentTarget;\n    let parent = child.closest('.block-stash-trade-item');\n    parent.remove();\n    element.preventDefault();\n};\n"],"names":["async","courseid","document","querySelector","dataset","courseId","itemdata","getItems","toggleMenu","e","dropdownlist","currentTarget","parentNode","style","display","querySelectorAll","forEach","listelement","listnode","item","items","type","closest","listitem","createElement","innerHTML","name","classList","add","setAttribute","itemid","id","imgurl","imageurl","addEventListener","addItemToTable","keyCode","appendChild","selector","searchbox","currentelement","searchterm","value","toLowerCase","listitems","innerText","indexOf","dropdowncontainers","target","dropdowncontainer","contains","typeinfo","itemnode","data","quantity","templatename","render","done","html","js","itemsbox","appendNodeContents","registerActions","deleteelements","getElementsByClassName","delement","deleteItem","element","remove","preventDefault"],"mappings":";;;;;;0mCAyBoBA,cAGZC,SADUC,SAASC,cAAc,2BACdC,QAAQC,SAC3BC,eAAiBC,SAASA,SAASN,mBA6B9BO,WAAWC,OAEZC,aADgBD,EAAEE,cACWC,WAAWT,cAAc,kBAC1DO,aAAaG,MAAMC,QAAyC,QAA9BJ,aAAaG,MAAMC,QAAqB,QAAU,OA7BjEZ,SAASa,iBAAiB,kBAChCC,SAASC,kBACdC,SAAWD,YAAYd,cAAc,UACpC,IAAIgB,QAAQb,SAASc,MAAO,KAEzBC,KAAOJ,YAAYK,QAAQ,yBAAyBlB,QAAQiB,KAE5DE,SAAWrB,SAASsB,cAAc,MACtCD,SAASE,UAAYN,KAAKO,KAC1BH,SAASI,UAAUC,IAAI,iBACvBL,SAASM,aAAa,WAAY,KAClCN,SAASnB,QAAQ0B,OAASX,KAAKY,GAC/BR,SAASnB,QAAQ4B,OAASb,KAAKc,SAC/BV,SAASW,iBAAiB,SAAUzB,GAAM0B,eAAe1B,EAAGY,QAC5DE,SAASW,iBAAiB,SAAUzB,IACd,KAAdA,EAAE2B,SACFD,eAAe1B,EAAGY,SAG1BH,SAASmB,YAAYd,cAabrB,SAASa,iBAAiB,mBAChCC,SAASsB,WACfA,SAASJ,iBAAiB,QAAS1B,YACnC8B,SAASJ,iBAAiB,SAAUzB,IACd,KAAdA,EAAE2B,SAAgC,KAAd3B,EAAE2B,SACtB5B,WAAWC,SAKLP,SAASa,iBAAiB,oBAChCC,SAASuB,YACjBA,UAAUL,iBAAiB,SAAUzB,QAC7B+B,eAAiB/B,EAAEE,cAEnBD,aADoB8B,eAAelB,QAAQ,uBACVnB,cAAc,kBAC/CsC,WAAaD,eAAeE,MAAMC,cAClCC,UAAYlC,aAAaK,iBAAiB,sBACzC,IAAII,QAAQyB,UAAW,EAEc,IADvBzB,KAAK0B,UAAUF,cACjBG,QAAQL,YACjBtB,KAAKN,MAAMC,QAAU,OAErBK,KAAKN,MAAMC,QAAU,eAMrCZ,SAASgC,iBAAiB,WAAYzB,IAChBP,SAASa,iBAAiB,oBAChCC,SAASuB,YACjBA,UAAUG,MAAQ,UAElBK,mBAAqB7C,SAASa,iBAAiB,uBAC/CyB,eAAiB/B,EAAEuC,OACvBD,mBAAmB/B,SAASiC,wBACpBvC,aAAeuC,kBAAkB9C,cAAc,sBAC9C8C,kBAAkBC,SAASV,gBAAiB,CAC7C9B,aAAaG,MAAMC,QAAU,WACzB8B,UAAYlC,aAAaK,iBAAiB,sBACzC,IAAII,QAAQyB,UACbzB,KAAKN,MAAMC,QAAU,sBAOnCqB,eAAiB,CAAC1B,EAAG0C,gBACnBC,SAAW3C,EAAEE,cACb0C,KAAO,CACPvB,OAAQsB,SAAShD,QAAQ0B,OACzBG,SAAUmB,SAAShD,QAAQ4B,OAC3BN,KAAM0B,SAASP,UACfS,SAAU,GAGVjC,KAAO8B,SAEPI,aAAyB,SAATlC,KAAmB,oCAAsC,wDACnEmC,OAAOD,aAAcF,MAAMI,MAAK,CAACC,KAAMC,UACzCC,SAAW1D,SAASC,cAAc,oCAAsCkB,KAAO,yBACzEwC,mBAAmBD,SAAUF,KAAMC,IAC7CG,sBAIKA,gBAAkB,SACvBC,eAAiB7D,SAAS8D,uBAAuB,+BAChD,IAAIC,YAAYF,eACjBE,SAAS/B,iBAAiB,QAASgC,4DAIrCA,WAAcC,UACJA,QAAQxD,cACDW,QAAQ,2BACpB8C,SACPD,QAAQE"}