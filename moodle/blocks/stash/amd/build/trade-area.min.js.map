{"version":3,"file":"trade-area.min.js","sources":["../src/trade-area.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Trade module.\n *\n * @copyright  2017 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/templates',\n    'block_stash/drop',\n    'core/notification',\n    'block_stash/trade',\n    'core/pubsub'\n], function($, Templates, Drop, notification, Trade, PubSub) {\n\n    /**\n     * Trade class.\n     *\n     * @class\n     * @param {Node} node The node.\n     */\n    function TradeArea(node) {\n        this._node = $(node);\n        this._setUp();\n        this._update();\n    }\n    TradeArea.prototype._node = null;\n\n    /**\n     * Setup.\n     */\n    TradeArea.prototype._setUp = function() {\n        PubSub.subscribe('block_stash/drop/pickedup', this._dropPickedUpListener.bind(this));\n        PubSub.subscribe('trade:pickedup', this._dropPickedUpListener.bind(this));\n    };\n\n    /**\n     * Whether the item is in this trade area.\n     *\n     * @param {Number} id The item ID.\n     * @return {Boolean}\n     */\n    TradeArea.prototype.containsItem = function(id) {\n        return this.getTradeItemNode(id).length > 0;\n    };\n\n    /**\n     * Listens to drop picked up events.\n     *\n     * @param {Event} e The event.\n     */\n    TradeArea.prototype._dropPickedUpListener = function(e) {\n        var userItem = e.useritem;\n        if (this.containsItem(userItem.getItem().get('id'))) {\n            this.updateTradeItemUserQuantity(userItem);\n        }\n    };\n\n    /**\n     * Can the user perform the trade?\n     *\n     * @return {Bool}\n     */\n    TradeArea.prototype.canTradeItems = function() {\n        var removeditemnodes = this._node.find('.removed-items');\n\n        var hasenough = true;\n        removeditemnodes.each(function(i, node) {\n            hasenough = hasenough && $(node).data('hasenough');\n        });\n\n        return hasenough;\n    };\n\n    /**\n     * Get the trade item node.\n     *\n     * @param {Number} id The item ID.\n     * @return {Node}\n     */\n    TradeArea.prototype.getTradeItemNode = function(id) {\n        return this._node.find('.removed-items[data-itemid=' + id + ']');\n    };\n\n    /**\n     * Update the quantity of a user item.\n     *\n     * @param {UserItem} userItem The user item.\n     */\n    TradeArea.prototype.updateTradeItemUserQuantity = function(userItem) {\n        var itemid = userItem.getItem().get('id'),\n            node = this.getTradeItemNode(itemid),\n            newQuantity = parseInt(userItem.get('quantity'), 10),\n            quantity = parseInt(node.attr('data-quantity'), 10),\n            tradeid = node.parent().attr('data-tradeid'),\n            name = userItem.getItem().get('name'),\n            enoughitems = (newQuantity >= quantity);\n\n        var context = {\n            enoughitems: enoughitems,\n            itemid: itemid,\n            quantity: quantity,\n            name: name,\n            userquantity: newQuantity\n        };\n\n        // I want to switch the template to show the new values.\n        Templates.render('block_stash/tradeitem_detail', context).done(function(html, js) {\n            Templates.replaceNodeContents($('.block-stash-trade-item-' + itemid + '[data-tradeid=\"' + tradeid + '\"]'), html, js);\n            this._update();\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Update the widget.\n     *\n     * @return {Void}\n     */\n    TradeArea.prototype._update = function() {\n        var btn = this._node.find('.accept-trade button').first();\n        if (!btn) {\n            return;\n        }\n\n        if (!this.canTradeItems()) {\n            btn.prop('disabled', true);\n        } else {\n            btn.prop('disabled', false);\n        }\n    };\n\n    return /** @alias module:block_stash/trade-area */ TradeArea;\n\n});\n"],"names":["define","$","Templates","Drop","notification","Trade","PubSub","TradeArea","node","_node","_setUp","_update","prototype","subscribe","this","_dropPickedUpListener","bind","containsItem","id","getTradeItemNode","length","e","userItem","useritem","getItem","get","updateTradeItemUserQuantity","canTradeItems","removeditemnodes","find","hasenough","each","i","data","itemid","newQuantity","parseInt","quantity","attr","tradeid","parent","name","context","enoughitems","userquantity","render","done","html","js","replaceNodeContents","fail","exception","btn","first","prop"],"mappings":";;;;;;AAsBAA,gCAAO,CACH,SACA,iBACA,mBACA,oBACA,oBACA,gBACD,SAASC,EAAGC,UAAWC,KAAMC,aAAcC,MAAOC,iBAQxCC,UAAUC,WACVC,MAAQR,EAAEO,WACVE,cACAC,iBAETJ,UAAUK,UAAUH,MAAQ,KAK5BF,UAAUK,UAAUF,OAAS,WACzBJ,OAAOO,UAAU,4BAA6BC,KAAKC,sBAAsBC,KAAKF,OAC9ER,OAAOO,UAAU,iBAAkBC,KAAKC,sBAAsBC,KAAKF,QASvEP,UAAUK,UAAUK,aAAe,SAASC,WACjCJ,KAAKK,iBAAiBD,IAAIE,OAAS,GAQ9Cb,UAAUK,UAAUG,sBAAwB,SAASM,OAC7CC,SAAWD,EAAEE,SACbT,KAAKG,aAAaK,SAASE,UAAUC,IAAI,aACpCC,4BAA4BJ,WASzCf,UAAUK,UAAUe,cAAgB,eAC5BC,iBAAmBd,KAAKL,MAAMoB,KAAK,kBAEnCC,WAAY,SAChBF,iBAAiBG,MAAK,SAASC,EAAGxB,MAC9BsB,UAAYA,WAAa7B,EAAEO,MAAMyB,KAAK,gBAGnCH,WASXvB,UAAUK,UAAUO,iBAAmB,SAASD,WACrCJ,KAAKL,MAAMoB,KAAK,8BAAgCX,GAAK,MAQhEX,UAAUK,UAAUc,4BAA8B,SAASJ,cACnDY,OAASZ,SAASE,UAAUC,IAAI,MAChCjB,KAAOM,KAAKK,iBAAiBe,QAC7BC,YAAcC,SAASd,SAASG,IAAI,YAAa,IACjDY,SAAWD,SAAS5B,KAAK8B,KAAK,iBAAkB,IAChDC,QAAU/B,KAAKgC,SAASF,KAAK,gBAC7BG,KAAOnB,SAASE,UAAUC,IAAI,QAG9BiB,QAAU,CACVC,YAHeR,aAAeE,SAI9BH,OAAQA,OACRG,SAAUA,SACVI,KAAMA,KACNG,aAAcT,aAIlBjC,UAAU2C,OAAO,+BAAgCH,SAASI,KAAK,SAASC,KAAMC,IAC1E9C,UAAU+C,oBAAoBhD,EAAE,2BAA6BiC,OAAS,kBAAoBK,QAAU,MAAOQ,KAAMC,SAC5GrC,WACPK,KAAKF,OAAOoC,KAAK9C,aAAa+C,YAQpC5C,UAAUK,UAAUD,QAAU,eACtByC,IAAMtC,KAAKL,MAAMoB,KAAK,wBAAwBwB,QAC7CD,MAIAtC,KAAKa,gBAGNyB,IAAIE,KAAK,YAAY,GAFrBF,IAAIE,KAAK,YAAY,KAMsB/C"}